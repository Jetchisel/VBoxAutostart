#!/bin/bash

# =========================================================================================== #
#: Title           : systemd-vboxinit                                                         #
#: Sypnosis        : systemd-vboxinit [OPTIONS]                                               #
#: Date Created    : Wed Oct  2 07:57:25 PHT 2013                                             #
#: Last Edit       : Fri Jan  3 11:51:40 PHT 2014 / Fri Jan  3 03:52:11 UTC 2014              #
#: License         : GPLv3                                                                    #
#: Version         : 1.5                                                                      #
#: Author          : Jason V. Ferrer '<jetchisel@opensuse.org>'                               #
#: Description     : Auto start sessions when booting and save sessions when host is stopped. #
#: Options         : {stop|start|license}                                                     #
# =========================================================================================== #

# ******************************************************************************************* #
#                                                                                             #
#              Check if VirtualBox is installed if not exit with an error.                    #
#                                                                                             #
# ******************************************************************************************* #

if ! type -P VirtualBox >/dev/null 2>&1; then
  if ! type -P virtualbox >/dev/null 2>&1; then
    echo "VirtualBox is either not installed or is not in your PATH!" >&2
    exit 1
  fi
fi

# ******************************************************************************************* #
#                                                                                             #
#              License function (required by GPL, see the LICENSE file)                       #
#                                                                                             #
# ******************************************************************************************* #

license() { 
    cat <<EOF
    
                     systemd-vboxinit 

Auto start sessions when booting and save sessions when host is 
stopped using systemd as its start up daemon.

Copyright (C) 2013  Jason V. Ferrer  '<jetchisel@opensuse.org>'

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
version 3 as published by the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
(see The LICENSE file) along with this program; if not, write
to the Free Software Foundation, Inc., 51 Franklin Street, Fifth
Floor, Boston, MA  02110-1301, USA.

EOF
return
}

# ******************************************************************************************* #
#                                                                                             #
#                                  VBoxManage Functions.                                      #
#                                                                                             #
# ******************************************************************************************* #

ListVms() {
  VBoxManage list vms
}

RunningVms() { 
  while read -r vm; do
    uuid=${vm##*"{"} 
    echo "${uuid%"}"*}"
  done < <(VBoxManage list runningvms) 
}

ExtraData() {
  VBoxManage getextradata "$uuid" 'pvbx/startupMode'
}

StartVms() {
  VBoxManage startvm "$uuid" --type headless
}

SaveVms() {
  VBoxManage controlvm "$uuid" savestate
}

# ******************************************************************************************* #
#                                                                                             #
#                          Function to start the vms Headless.                                # 
#                                                                                             #
# ******************************************************************************************* #

start() {
  while read -r line; do 
    uuid=${line##*"{"}
    uuid=${uuid%"}"*}
    VmName=${line#*\"}
    VmName=${VmName%%\"*}
  
    if [[ $(ExtraData) = *auto* ]]; then
      if ! grep -q "${uuid}" < <(RunningVms); then
        printf '\n%s\n' "Starting Machine '$VmName'..."
        StartVms
      else 
        printf '\n%s\n' "Machine '$VmName' is already running..."
      fi
    elif [[ $(ExtraData) != *auto* ]]; then
      printf '\n%s\n' "Machine '$VmName' is not set to auto...."
      echo
    fi 
  done < <(ListVms) 
}

# ******************************************************************************************* #
#                                                                                             #
#              Function to save vms state instead of shutting down completely.                #
#                                                                                             #
# ******************************************************************************************* #

stop() {
   while read -r line; do 
     uuid=${line##*"{"}
     uuid=${uuid%"}"*}
     VmName=${line#*\"}
     VmName=${VmName%%\"*} 
     
     if grep -q "${uuid}" < <(RunningVms); then
       printf '\n%s\n' "Saving machine '$VmName' state..."
       SaveVms
       echo
     fi
   done < <(ListVms)
}

# ******************************************************************************************** #
#                                                                                              #
#                              Check for a command line options.                               #
#                                                                                              #
# ******************************************************************************************** #

case $1 in
  stop|start|license) "$1" ;;
  *) echo "Usage: ${0##*/} {start|stop|license}" >&2 
     exit 1 ;;
esac

# ******************************************************************************************** #
#                                                                                              #
#                                   Set the exit staus.                                        #
#                                                                                              #
# ******************************************************************************************** #

exit 0

# ============================================================================================ #
#                                                                                              #
#                                  >>> END OF SCRIPT <<<                                       #
#                                                                                              #
# ============================================================================================ #
